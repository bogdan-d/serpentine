---
name: Build Serpentine ISO
on:
  workflow_dispatch:
  workflow_call:
  # workflow_run:
  #   workflows: ["Build Serpentine"]
  #   types:
  #     - completed
  #   branches:
  #     - main

env:
  IMAGE_NAME: "${{ github.event.repository.name }}"  # output image name, usually same as repo name
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"  # do not edit

jobs:
  build_iso:
    name: Build ISO images
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
      id-token: write
    if: github.event.workflow_run.conclusion == 'success'

    strategy:
      fail-fast: false
      matrix:
        base_image:
          - serpentine
          - serpentine-nvidia

    steps:

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1

      - name: Checkout Repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v5
        with:
          submodules: recursive

      # QUICK CLEANUP: reclaim common caches and large SDKs before heavy pulls
      - name: Quick runner cleanup & report
        run: |
          echo "Disk: before cleanup"
          df -h /
          echo "Containers storage (if present):"
          sudo du -sh /var/lib/containers || true

          # Remove known large SDKs/tooling that GH runners often have
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true

          # Clean package manager caches
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get -y autoremove || true
            sudo apt-get -y clean || true
            sudo rm -rf /var/cache/apt/archives/* || true
          fi
          if command -v dnf >/dev/null 2>&1; then
            sudo dnf -y clean all || true
            sudo rm -rf /var/cache/dnf/* || true
          fi

          # Prune Docker if present (best-effort)
          if command -v docker >/dev/null 2>&1; then
            sudo docker system prune -af || true
          fi

          # Small temp cleanup
          sudo rm -rf /tmp/* /var/tmp/* || true

          echo "Disk: after cleanup"
          df -h /
          sudo du -sh /var/lib/containers || true

      # You only use this action if the container-storage-action proves to be unreliable, you don't need to enable both
      # This is optional, but if you see that your builds are way too big for the runners, you can enable this by uncommenting the following lines:
      - name: Maximize build space
        uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - name: Mount BTRFS for podman storage
        id: container-storage-action
        uses: ublue-os/container-storage-action@main

        # Fallback to the remove-unwanted-software-action if github doesn't allocate enough space
        # See: https://github.com/ublue-os/container-storage-action/pull/11
        continue-on-error: true
        with:
          target-dir: /var/lib/containers
          mount-opts: compress-force=zstd:2

      - name: Generate output image ref
        id: gen_image_ref
        run: |
          IMAGE_NAME="${BASE_IMAGE/bazzite/serpentine}" | sed 's/-deck//'
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          if [[ "$BASE_IMAGE" == *"nvidia"* ]]; then
            IMAGE_NAME="${IMAGE_NAME}-nvidia"
            echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          fi

      - name: Install Just
        run: |
          sudo wget -O /usr/local/bin/just https://github.com/casey/just/releases/download/1.34.0/just-1.34.0-x86_64-unknown-linux-musl.tar.gz
          sudo tar -xzf /usr/local/bin/just -C /usr/local/bin
          sudo chmod +x /usr/local/bin/just

      - name: Pull built image
        run: |
          podman pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest

      - name: Build ISO
        run: |
          if [[ "$BASE_IMAGE" == *"nvidia"* ]]; then
            just rebuild-iso-nvidia ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          else
            just rebuild-iso ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          fi

      - name: Upload ISO artifacts
        uses: actions/upload-artifact@v5
        with:
          name: serpentine-${{ env.IMAGE_NAME }}-iso
          path: output/bootiso/install.iso
          retention-days: 7